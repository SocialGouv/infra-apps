# Production overrides for the no-package-malware umbrella chart.
#
# This file is used by the ArgoCD ApplicationSet for ovh-prod
# (see applications/no-package-malware.yaml). It is merged on top
# of `values.yaml`.
#
# Here we enable ingress for all externally exposed services and
# configure production hosts under the fabrique.social.gouv.fr
# domain with TLS managed by cert-manager.

no-package-malware:
  # Base images pull policy overrides for production.
  image:
    api:
      pullPolicy: Always
    app:
      pullPolicy: Always
    registry:
      pullPolicy: Always

  # SPA runtime configuration: API and registry base URLs, plus the
  # public URL of the request access portal used by the backend to
  # redirect /request-access.
  app:
    apiBaseUrl: "https://no-package-malware-api.fabrique.social.gouv.fr"
    registryStrictUrl: "https://no-package-malware-strict.fabrique.social.gouv.fr"
    registryLenientUrl: "https://no-package-malware-lenient.fabrique.social.gouv.fr"
    accessRequestPortalUrl: "https://no-package-malware.fabrique.social.gouv.fr/request-access"

  ingress:
    enabled: true

    # Use the shared nginx ingress controller.
    className: nginx

    # Standard cert-manager annotations for production certificates.
    annotations:
      cert-manager.io: cluster-issuer
      cert-manager.io/cluster-issuer: letsencrypt-prod
      kubernetes.io/tls-acme: "true"

    # Single TLS secret covering all external hostnames.
    tls:
      - secretName: no-package-malware-tls
        hosts:
          - no-package-malware-api.fabrique.social.gouv.fr
          - no-package-malware.fabrique.social.gouv.fr
          - no-package-malware-strict.fabrique.social.gouv.fr
          - no-package-malware-lenient.fabrique.social.gouv.fr

    # API ingress (decision/admin API)
    api:
      enabled: true
      host: no-package-malware-api.fabrique.social.gouv.fr
      # Path and port fall back to the embedded chart defaults:
      #   path: /api
      #   port: 4000

    # App ingress (dashboard UI)
    app:
      enabled: true
      host: no-package-malware.fabrique.social.gouv.fr
      # Defaults:
      #   path: /
      #   port: 4173

    # Verdaccio strict registry ingress
    verdaccioStrict:
      enabled: true
      host: no-package-malware-strict.fabrique.social.gouv.fr
      path: "/"
      # Defaults:
      #   path: /strict
      #   port: 4873

    # Verdaccio lenient registry ingress
    verdaccioLenient:
      enabled: true
      host: no-package-malware-lenient.fabrique.social.gouv.fr
      path: "/"
      # Defaults:
      #   path: /lenient
      #   port: 4874

  # High-availability for stateless services (api, app, Verdaccio)
  ha:
    enabled: true
    # replicas:
    #   api: 2
    #   app: 2
    #   verdaccioStrict: 2
    #   verdaccioLenient: 2

  # MongoDB connection – keep empty to use default in-cluster URI from mongodb subchart
  mongo:
    uri: ""
    auth:
      enabled: true
      secretName: no-package-malware-mongodb-auth
      usernameKey: USERDB_USER
      passwordKey: USERDB_PASSWORD
      authSource: secure_registry

  # Groundhog2k MongoDB subchart configuration (see app chart for base defaults).
  mongodb:
    enabled: true

    replicaSet:
      enabled: true
      name: repl
      secondaries: 2
      # External Secret providing the replica set key as a file named "keyfile".
      keySecretName: no-package-malware-mongodb-key

    storage:
      requestedSize: 20Gi
      className: ""

    settings:
      rootUsername: ""
      rootPassword: ""

    userDatabase: {}

    extraEnvSecrets:
      - no-package-malware-mongodb-auth

  # Valkey connection – use Sentinel mode in prod
  valkey:
    mode: sentinel
    # Defaults to <release>-valkeyha when empty and valkeyha.enabled=true.
    host: ""
    port: 6379
    sentinel:
      masterName: mymaster
      # Defaults to <release>-valkeyha-sentinel when empty and
      # valkeyha.sentinel.enabled=true.
      host: ""
      port: 26379

  # CloudPirates Valkey subchart configuration (HA with Sentinel)
  valkeyha:
    enabled: true

    architecture: replication
    replicaCount: 3

    auth:
      enabled: false

    persistence:
      enabled: true
      size: 10Gi
      storageClass: ""

    sentinel:
      enabled: true
      masterName: mymaster
      quorum: 2
      downAfterMilliseconds: 1500
      failoverTimeout: 15000
      parallelSyncs: 1
      service:
        type: ClusterIP
        port: 26379

    # Spread pods across nodes for better availability
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - valkey
              topologyKey: kubernetes.io/hostname

    resources:
      requests:
        memory: "512Mi"
        cpu: "250m"
      limits:
        memory: "1Gi"
        cpu: "500m"

  # Use the SealedSecret-backed admin credentials secret for the API
  accessAdmin:
    credentialsSecret:
      enabled: true
      secretName: no-package-malware-admin
      usernameKey: ACCESS_ADMIN_USERNAME
      passwordKey: ACCESS_ADMIN_PASSWORD

  components:
    api:
      resources:
        requests:
          cpu: "250m"
          memory: "512Mi"
        limits:
          cpu: "500m"
          memory: "1Gi"

    app:
      resources:
        requests:
          cpu: "100m"
          memory: "128Mi"
        limits:
          cpu: "300m"
          memory: "512Mi"

    verdaccioStrict:
      resources:
        requests:
          cpu: "300m"
          memory: "512Mi"
        limits:
          cpu: "1000m"
          memory: "1Gi"

    verdaccioLenient:
      resources:
        requests:
          cpu: "300m"
          memory: "512Mi"
        limits:
          cpu: "1000m"
          memory: "1Gi"

    verdaccioMalware:
      resources:
        requests:
          cpu: "300m"
          memory: "512Mi"
        limits:
          cpu: "1000m"
          memory: "1Gi"
